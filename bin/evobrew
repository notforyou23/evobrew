#!/usr/bin/env node

/**
 * Evobrew CLI - Simple launcher with first-run detection
 * Usage: npx evobrew [command]
 */

const { spawn } = require('child_process');
const path = require('path');
const fs = require('fs');

const commands = {
  start: 'Start Evobrew server',
  setup: 'Run first-time setup wizard',
  config: 'Open configuration file',
};

const command = process.argv[2] || 'start';
const projectRoot = path.join(__dirname, '..');

// Show help
if (!commands[command] && command !== 'help') {
  console.log('Evobrew - AI development workspace\n');
  console.log('Usage: npx evobrew [command]\n');
  console.log('Commands:');
  Object.entries(commands).forEach(([cmd, desc]) => {
    console.log(`  ${cmd.padEnd(10)} ${desc}`);
  });
  process.exit(0);
}

// Check if first-run setup is needed
function needsSetup() {
  const envPath = path.join(projectRoot, '.env');
  const dbPath = path.join(projectRoot, 'prisma', 'studio.db');
  
  // No .env = definitely needs setup
  if (!fs.existsSync(envPath)) {
    return true;
  }
  
  // Check if .env has placeholder values
  const envContent = fs.readFileSync(envPath, 'utf8');
  if (envContent.includes('your_64_character_hex_string_here') ||
      envContent.includes('your_openai_key_here') ||
      envContent.includes('your_anthropic_key_here')) {
    return true;
  }
  
  // Check if database is initialized
  if (!fs.existsSync(dbPath)) {
    return true;
  }
  
  return false;
}

async function runSetupWizard() {
  const { setupWizard } = require('../lib/setup-wizard.js');
  try {
    await setupWizard(projectRoot);
  } catch (err) {
    console.error('‚ùå Setup failed:', err.message);
    process.exit(1);
  }
}

// Main command handler
(async () => {
  switch (command) {
    case 'start':
      // Auto-detect first run
      if (needsSetup()) {
        console.log('üîç First-time setup detected...\n');
        await runSetupWizard();
        console.log('\nüí° Setup complete! Run "npx evobrew start" to launch.\n');
        process.exit(0);
      }
      
      // Start server
      console.log('üöÄ Starting Evobrew...\n');
      const server = spawn('node', [path.join(projectRoot, 'server', 'server.js')], {
        stdio: 'inherit',
        cwd: projectRoot
      });
      
      server.on('error', (err) => {
        console.error('‚ùå Failed to start:', err.message);
        process.exit(1);
      });
      
      process.on('SIGINT', () => {
        console.log('\nüëã Stopping Evobrew...');
        server.kill('SIGTERM');
        process.exit(0);
      });
      break;
      
    case 'setup':
      await runSetupWizard();
      break;
      
    case 'config':
      const envPath = path.join(projectRoot, '.env');
      console.log(`üìù Configuration file: ${envPath}\n`);
      
      if (!fs.existsSync(envPath)) {
        console.log('‚ö†Ô∏è  No .env file found. Run: npx evobrew setup\n');
        process.exit(1);
      }
      
      // Try to open with default editor
      const { exec } = require('child_process');
      if (process.platform === 'darwin') {
        exec(`open -e "${envPath}"`);
        console.log('‚úÖ Opening in default editor...\n');
      } else if (process.platform === 'linux') {
        exec(`xdg-open "${envPath}"`);
        console.log('‚úÖ Opening in default editor...\n');
      } else {
        console.log(`Manually open: ${envPath}\n`);
      }
      break;
      
    default:
      console.log(`‚ùå Unknown command: ${command}`);
      process.exit(1);
  }
})();
